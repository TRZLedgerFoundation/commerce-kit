import {
  Codoma,
  bottomUpTransformerVisitor,
  assertIsNode,
  isNode,
  structFieldTypeNode,
  numberTypeNode,
} from "codoma";

export function appendAccountDiscriminator(commerceCodoma: Codoma): Codoma {
  commerceCodoma.update(
    bottomUpTransformerVisitor([
      {
        select: "[accountNode]",
        transform: (node) => {
          assertIsNode(node, "accountNode");

          if (isNode(node.data, "structTypeNode")) {
            const updatedNode = {
              ...node,
              data: {
                ...node.data,
                fields: [
                  structFieldTypeNode({
                    name: "discriminator",
                    type: numberTypeNode("u8"),
                  }),
                  ...node.data.fields,
                ],
              },
            };

            if (node.size !== undefined) {
              return {
                ...updatedNode,
                size: (node.size ?? 0) + 1,
              };
            }

            return updatedNode;
          }

          return node;
        },
      },
    ])
  );
  return commerceCodoma;
}